# this local Makefile includes the cluster targets

OPTHOST	   	 := $(shell uname -n | sed 's/\(.zib.de\)//g' | tr -cd '[:alpha:]')

-include $(SCIPDIR)/make/local/make.$(OPTHOST)

.PHONY: testcluster
testcluster: check/check_cluster.sh check/configuration_cluster.sh check/configuration_set.sh check/configuration_logfiles.sh check/evalcheck_cluster.sh check/check.awk
		cd check; \
		$(SHELL) ./check_cluster.sh $(TEST) $(MAINFILE) $(SETTINGS) \
		$(notdir $(MAINFILE)) $(TIME) $(NODES) $(MEM) \
		$(THREADS) $(FEASTOL) $(LPS) $(DISPFREQ) $(CONTINUE) \
		$(QUEUETYPE) $(QUEUE) $(PPN) $(CLIENTTMPDIR) \
		$(NOWAITCLUSTER) $(EXCLUSIVE) $(PERMUTE) $(SEEDS) $(VALGRIND) $(REOPT) $(OPTCOMMAND) $(SETCUTOFF) $(VISUALIZE);

.PHONY: testnodes
testnodes:
		cd check; \
                $(SHELL) ./check_nodes.sh $(TEST) $(MAINFILE) $(SETTINGS) \
                $(notdir $(MAINFILE)) $(TIME) $(NODES) $(MEM) \
                $(THREADS) $(FEASTOL) $(LPS) $(DISPFREQ) $(CONTINUE) \
                $(QUEUETYPE) $(QUEUE) $(NODES) $(PPN) $(CLIENTTMPDIR) \
                $(NOWAITCLUSTER) $(EXCLUSIVE) $(PERMUTE) $(VALGRIND) $(REOPT) $(OPTCOMMAND) $(SETCUTOFF) $(VISUALIZE);

.PHONY: testclustercpx
testclustercpx:
		cd check; \
		$(SHELL) ./check_cluster.sh $(TEST) $(CPLEX) $(SETTINGS) \
                $(notdir $(CPLEX)).$(OSTYPE).$(ARCH) $(TIME) $(NODES) $(MEM) \
                $(THREADS) $(FEASTOL) $(LPS) $(DISPFREQ) $(CONTINUE) \
                $(QUEUETYPE) $(QUEUE) $(PPN) $(CLIENTTMPDIR) \
                $(NOWAITCLUSTER) $(EXCLUSIVE) $(PERMUTE) $(SEEDS) $(VALGRIND) false $(OPTCOMMAND) $(SETCUTOFF) $(VISUALIZE);

.PHONY: testclustercbc
testclustercbc:
		cd check; \
		$(SHELL) ./check_cluster_cbc.sh $(TEST) $(CBC) $(SETTINGS) \
		$(OSTYPE).$(ARCH) $(TIME) $(NODES) $(MEM) \
		$(THREADS) $(FEASTOL) $(CONTINUE) $(QUEUETYPE) $(QUEUE) $(PPN) \
		$(CLIENTTMPDIR) $(NOWAITCLUSTER) $(EXCLUSIVE);

.PHONY: testclustergurobi
testclustergurobi:
		cd check; \
		$(SHELL) ./check_cluster_gurobi.sh $(TEST) $(GUROBI) $(SETTINGS) \
		$(OSTYPE).$(ARCH) $(TIME) $(NODES) $(MEM) \
		$(THREADS) $(FEASTOL) $(DISPFREQ) $(CONTINUE) $(QUEUETYPE) $(QUEUE) $(PPN) \
		$(CLIENTTMPDIR) $(NOWAITCLUSTER) $(EXCLUSIVE);

.PHONY: testclusterxpress
testclusterxpress:
		cd check; \
		$(SHELL) ./check_cluster_xpress.sh $(TEST) $(XPRESS) $(SETTINGS) \
		$(OSTYPE).$(ARCH) $(TIME) $(NODES) $(MEM) \
		$(THREADS) $(FEASTOL) $(DISPFREQ) $(CONTINUE) $(QUEUETYPE) $(QUEUE) $(PPN) \
		$(CLIENTTMPDIR) $(NOWAITCLUSTER) $(EXCLUSIVE);

.PHONY: testclustermosek
testclustermosek:
		cd check; \
		$(SHELL) ./check_cluster_mosek.sh $(TEST) $(MOSEK) $(SETTINGS) \
		$(OSTYPE).$(ARCH) $(TIME) $(NODES) $(MEM) \
		$(THREADS) $(FEASTOL) $(DISPFREQ) $(CONTINUE) $(QUEUETYPE) $(QUEUE) $(PPN) \
		$(CLIENTTMPDIR) $(NOWAITCLUSTER) $(EXCLUSIVE);

.PHONY: testgamscluster
testgamscluster:
		cd check; \
		$(SHELL) ./check_gamscluster.sh $(TEST) $(GAMS) "$(GAMSSOLVER)" $(SETTINGS) \
		$(OSTYPE).$(ARCH) $(TIME) $(NODES) $(MEM) "$(GAP)" $(THREADS) $(CONTINUE) \
		"$(CONVERTSCIP)" $(QUEUETYPE) $(QUEUE) $(PPN) $(CLIENTTMPDIR) $(NOWAITCLUSTER) $(EXCLUSIVE) $(SETCUTOFF);

SCIPEXAMPLES	=	examples/Binpacking examples/CallableLibrary applications/Coloring \
                  examples/Eventhdlr examples/GMI examples/LOP examples/MIPSolver \
                  applications/Scheduler applications/STP examples/TSP examples/VRP

.PHONY: testexamples
testexamples:
		@-echo "" > exampletestsummary.log
		@$(foreach EXAMPLE, $(SCIPEXAMPLES), echo $(EXAMPLE);  $(MAKE) -C $(EXAMPLE) $^ test && { echo "tested $(EXAMPLE) example -- success" >> exampletestsummary.log; } \
			|| { echo "tested example $(EXAMPLE) -- FAIL" >> exampletestsummary.log; };)
		@-echo "Summary: "
		@-cat exampletestsummary.log
		@-rm -f exampletestsummary.log

.PHONY: docexamples
docexamples:
		@$(foreach EXAMPLE, $(SCIPEXAMPLES), $(MAKE) -C $(EXAMPLE) $^ doc || exit 1;)

.PHONY: coverage
coverage:
		$(SHELL) ./check/check_coverage.sh $(MAINFILE) $(notdir $(MAINFILE)).$(HOSTNAME) $(MEM) $(VERSION) $(LPS) $(OBJDIR);

.PHONY: solchecker
solchecker:
		cd ./check/solchecker; \
		$(MAKE);
